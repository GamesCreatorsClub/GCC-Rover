#!/usr/bin/env python3

import os
import sys
import pyroscommon as pc

service = False

args = pc.processCommonHostSwitches(pc.args)


def printHelp(rc):
    print("usage: pyros [<host[:port]>] upload [-s|--service] <processId> <file>")
    print("")
    print("    -h                    help message")
    print("    -s|--service          uploaded code is supposed to be service.")
    print("    <processId>           id process is going to be known from this point on.")
    print("    <file>                python file name to be uploaded.")
    sys.exit(rc)


if len(args) < 2:
    print("Not enought arguments. Got only " + str(len(args)) + ".")
    print(str(args))
    printHelp(1)

if pc.hasHelpSwitch:
    printHelp(0)

if args[0] == "-s" or args[0] == "--service":
    service = True

processId = args[0]

filename = args[1]


if not os.path.exists(filename):
    print("File '" + filename + "' does not exist.")
    sys.exit(1)


def executeCommand(client):
    file = open(filename)
    fileContent = file.read()
    file.close()

    client.publish("exec/" + processId + "/process", fileContent)

    if service:
        client.publish("exec/" + processId, "make-service")
        client.publish("exec/" + processId, "enable-service")

    return True


def processOut(line, pId):
    return False


def processStatus(line, pId):
    if line.startswith("stored"):
        return False
    return True


pc.processCommand(processId, executeCommand, processOut, processStatus)
